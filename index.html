<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPP 프로젝트 이슈 분석 대시보드 (Ver 0.02)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #111827; /* Dark Blue-Gray */
            color: #E5E7EB; /* Light Gray */
        }
        .card {
            background-color: #1F2937; /* Darker Blue-Gray */
            border: 1px solid #374151;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(14, 165, 233, 0.1);
        }
        .tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.8rem;
        }
        .tag-tech { background-color: #1D4ED8; color: #DBEAFE; }
        .tag-logistics { background-color: #9A3412; color: #FEF3C7; }
        .tag-process { background-color: #166534; color: #D1FAE5; }
        .tag-directing { background-color: #7E22CE; color: #F3E8FF; }

        .filter-btn {
            transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: #0EA5E9; /* Sky Blue */
            color: #ffffff;
            box-shadow: 0 4px 14px rgba(14, 165, 233, 0.3);
        }
        
        /* Calendar Styles */
        .calendar-day-container {
            position: relative;
            aspect-ratio: 1/1;
        }
        .calendar-day {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        button.calendar-day {
            background-color: #374151; /* Default issue day color */
            cursor: pointer;
        }
        button.calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        button.calendar-day.selected {
            background-color: #0EA5E9 !important;
            color: #fff;
            transform: scale(1.1);
            z-index: 10;
        }
        .issue-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #f59e0b;
            color: #111827;
            font-size: 0.65rem;
            font-weight: 700;
            width: 1.2rem;
            height: 1.2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .calendar-tooltip {
            visibility: hidden;
            width: 240px;
            background-color: #111827;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #374151;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .calendar-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
        .calendar-day-container:hover .calendar-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .calendar-tooltip ul { list-style-type: none; padding: 0; }
        .calendar-tooltip li {
            font-size: 0.8rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-tooltip li::before {
            content: '•';
            color: #0ea5e9;
            font-weight: bold;
            display: inline-block; 
            width: 1em;
            margin-left: -0.5em;
        }

        /* Modal Styles */
        #issue-modal {
            transition: opacity 0.3s ease;
        }
        #modal-content-wrapper {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-12">
            <p class="text-sm text-sky-400 mb-2 font-mono">Ver 0.02</p>
            <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-gradient-to-r from-sky-400 to-cyan-300 text-transparent bg-clip-text">MPP 프로젝트 최종 이슈 분석</h1>
            <p class="text-lg text-gray-400">2025.04.29 - 2025.05.11 발생 이슈 트래커</p>
        </header>

        <!-- Calendar Section -->
        <section class="mb-12">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-200">이슈 발생 캘린더</h2>
            <div id="calendar-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <!-- 자바스크립트로 캘린더 생성 -->
            </div>
        </section>

        <!-- Filter Buttons -->
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-10" id="filter-container">
            <button class="filter-btn active text-white font-semibold py-2 px-5 rounded-full bg-gray-700 hover:bg-sky-600" data-filter="all">전체</button>
            <button class="filter-btn text-white font-semibold py-2 px-5 rounded-full bg-gray-700 hover:bg-sky-600" data-filter="기술 및 장비">기술/장비</button>
            <button class="filter-btn text-white font-semibold py-2 px-5 rounded-full bg-gray-700 hover:bg-sky-600" data-filter="물류 및 현장 세팅">물류/세팅</button>
            <button class="filter-btn text-white font-semibold py-2 px-5 rounded-full bg-gray-700 hover:bg-sky-600" data-filter="프로세스 및 커뮤니케이션">프로세스</button>
            <button class="filter-btn text-white font-semibold py-2 px-5 rounded-full bg-gray-700 hover:bg-sky-600" data-filter="연출">연출</button>
        </div>

        <!-- Issue Cards Grid -->
        <div id="issues-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            <!-- 자바스크립트로 카드 생성 -->
            <p class="col-span-full text-center text-gray-400">이슈 데이터를 불러오는 중입니다...</p>
        </div>
    </div>

    <!-- Modal for Issue Preview -->
    <div id="issue-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0" 
         role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div id="modal-content-wrapper" class="w-full max-w-2xl transform scale-95">
            <!-- Modal content will be injected here -->
        </div>
    </div>


<script>
(function() { // IIFE
    // --- 상수 정의 (매직 스트링 제거) ---
    const FILTER_TYPE = {
        CATEGORY: 'category',
        DATE: 'date'
    };
    const ALL_FILTER = 'all';
    const ISSUES_JSON_PATH = './issues.json'; // 데이터 파일 경로

    // --- DOM 요소 ---
    const issuesGrid = document.getElementById('issues-grid');
    const filterContainer = document.getElementById('filter-container');
    const calendarWrapper = document.getElementById('calendar-wrapper');
    const modal = document.getElementById('issue-modal');
    const modalContentWrapper = document.getElementById('modal-content-wrapper');
    
    // --- 상태 관리 ---
    let currentFilter = { type: FILTER_TYPE.CATEGORY, value: ALL_FILTER };
    let lastFocusedElement;
    let allIssuesData = []; // 모든 이슈 데이터를 저장할 배열

    // --- 설정 및 템플릿 ---
    const categoryStyles = {
        '기술 및 장비': { tag: 'tag-tech', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-blue-400" aria-hidden="true"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>` },
        '물류 및 현장 세팅': { tag: 'tag-logistics', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-orange-400" aria-hidden="true"><path d="M14 16.5V13a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v3.5"/><path d="M20 12V6H4v6"/><path d="M2 12h20"/><path d="M20 16.5a3.5 3.5 0 0 1-7 0"/><path d="M4 16.5a3.5 3.5 0 0 0 7 0"/></svg>` },
        '프로세스 및 커뮤니케이션': { tag: 'tag-process', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-green-400" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>` },
        '연출': { tag: 'tag-directing', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-purple-400" aria-hidden="true"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>` },
    };

    // --- 렌더링 함수 ---

    /** 모든 이슈 카드를 한 번만 렌더링하는 함수 */
    const renderAllIssueCards = (issues) => {
        issuesGrid.innerHTML = ''; // 초기 메시지 제거
        if (!issues || issues.length === 0) {
            issuesGrid.innerHTML = '<p class="col-span-full text-center text-gray-400">표시할 이슈가 없습니다.</p>';
            return;
        }

        issues.forEach(issue => {
            const style = categoryStyles[issue.category];
            const card = document.createElement('div');
            card.className = 'card rounded-xl overflow-hidden flex flex-col h-full';
            // 필터링을 위한 데이터 속성 추가
            card.setAttribute('data-issue-no', issue.no);
            card.setAttribute('data-category', issue.category);
            card.setAttribute('data-date', issue.isoDate);
            
            // 사전 해결 방안이 있을 경우 표시할 HTML 생성
            const preSolutionHTML = issue.preSolution
                ? `<div>
                        <h4 class="font-semibold text-amber-400 text-xs mb-1 uppercase">사전 해결 방안</h4>
                        <p class="text-gray-300 truncate" title="${issue.preSolution.title}">${issue.preSolution.title}</p>
                   </div>`
                : '';

            card.innerHTML = `
                <div class="p-6 flex-grow">
                    <div class="flex items-center justify-between mb-4">
                        <span class="tag ${style.tag}">${issue.category}</span>
                        <span class="text-xs font-mono text-gray-500">No. ${issue.no}</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-100 flex items-start mb-1">${style.icon} <span class="flex-1">${issue.cause}</span></h3>
                    <div class="flex items-center text-sm text-gray-400 mb-4">
                        <span>발생: ${issue.date}</span><span class="mx-2">|</span><span>소요: ${issue.duration}</span>
                    </div>
                </div>
                <div class="border-t border-gray-700/60 mx-6"></div>
                <div class="p-6 pt-4 space-y-3 text-sm">
                    <div>
                        <h4 class="font-semibold text-gray-400 text-xs mb-1 uppercase">문제 상황 요약</h4>
                        <p class="text-gray-300 truncate" title="${issue.background}">${issue.background}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-sky-400 text-xs mb-1 uppercase">해결 조치 요약</h4>
                        <p class="text-gray-300 truncate" title="${issue.solution}">${issue.solution}</p>
                    </div>
                    ${preSolutionHTML}
                </div>`;
            issuesGrid.appendChild(card);
        });
    };

    /** 필터 상태에 따라 카드 가시성을 업데이트하는 함수 */
    const updateCardVisibility = () => {
        const cards = issuesGrid.querySelectorAll('.card');
        cards.forEach(card => {
            const cardCategory = card.dataset.category;
            const cardDate = card.dataset.date;
            let shouldShow = false;

            if (currentFilter.type === FILTER_TYPE.CATEGORY) {
                shouldShow = currentFilter.value === ALL_FILTER || currentFilter.value === cardCategory;
            } else if (currentFilter.type === FILTER_TYPE.DATE) {
                shouldShow = currentFilter.value === cardDate;
            }

            // 'display: flex'는 .card의 기본 display 속성
            card.style.display = shouldShow ? 'flex' : 'none';
        });
    };

    const renderCalendar = (year, month, issuesByDate) => { // month is 0-indexed
        const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
        const daysOfWeek = ['월', '화', '수', '목', '금', '토', '일'];
        
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let startingDay = firstDay.getDay(); 
        startingDay = startingDay === 0 ? 6 : startingDay - 1; // Monday start

        const calendarContainer = document.createElement('div');
        calendarContainer.className = 'bg-gray-800 p-4 rounded-lg';
        
        let html = `<div class="text-center font-bold text-lg mb-4">${year}년 ${monthNames[month]}</div>
                    <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-2">`;
        daysOfWeek.forEach(day => { html += `<div>${day}</div>`; });
        html += `</div><div class="grid grid-cols-7 gap-1 text-center text-sm">`;
        for (let i = 0; i < startingDay; i++) { html += `<div></div>`; }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const issuesOnDay = issuesByDate[dateStr];
            
            let tooltipHTML = '';
            if (issuesOnDay) {
                tooltipHTML += '<div class="calendar-tooltip"><ul>';
                issuesOnDay.forEach(issue => {
                    tooltipHTML += `<li>${issue.cause}</li>`;
                });
                tooltipHTML += '</ul></div>';
            }

            html += `<div class="calendar-day-container">`;
            if (issuesOnDay) {
                html += `<button class="calendar-day" data-date="${dateStr}" aria-label="${day}일, 이슈 ${issuesOnDay.length}개">
                            <span>${day}</span>
                            <span class="issue-badge">${issuesOnDay.length}</span>
                         </button>
                         ${tooltipHTML}`;
            } else {
                html += `<div class="calendar-day"><span>${day}</span></div>`;
            }
            html += `</div>`;
        }
        html += `</div>`;
        calendarContainer.innerHTML = html;
        calendarWrapper.appendChild(calendarContainer);
    };
    
    // --- UI 업데이트 및 이벤트 리스너 ---
    const updateFilterCounts = (issues) => {
        const counts = issues.reduce((acc, issue) => {
            acc[issue.category] = (acc[issue.category] || 0) + 1;
            return acc;
        }, {});
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const filter = btn.dataset.filter;
            if(filter === ALL_FILTER) {
                btn.textContent = `전체 (${issues.length})`;
            } else if (counts[filter]) {
                const baseText = btn.textContent.split('(')[0].trim();
                btn.textContent = `${baseText} (${counts[filter]})`;
            } else {
                 const baseText = btn.textContent.split('(')[0].trim();
                 btn.textContent = `${baseText} (0)`;
            }
        });
    };

    const updateUI = () => {
        // Update Calendar Selection
        document.querySelectorAll('button.calendar-day').forEach(day => {
            day.classList.toggle('selected', currentFilter.type === FILTER_TYPE.DATE && day.dataset.date === currentFilter.value);
        });
        
        // Update Filter Button Selection
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', currentFilter.type === FILTER_TYPE.CATEGORY && btn.dataset.filter === currentFilter.value);
        });
        
        updateCardVisibility();
    };

    filterContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentFilter = { type: FILTER_TYPE.CATEGORY, value: e.target.dataset.filter };
            updateUI();
        }
    });

    const openModal = (issue) => {
        lastFocusedElement = document.activeElement;
        const style = categoryStyles[issue.category];
        
        // 사전 해결 방안이 있을 경우 모달에 표시할 HTML 생성
        const preSolutionModalHTML = issue.preSolution
            ? `<div>
                   <h4 class="font-semibold text-amber-400 mb-2">사전 해결 방안</h4>
                   <a href="${issue.preSolution.link}" target="_blank" rel="noopener noreferrer" class="text-sky-300 leading-relaxed underline hover:text-sky-200 transition-colors inline-flex items-center">
                       ${issue.preSolution.title}
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                   </a>
               </div>`
            : '';

        modalContentWrapper.innerHTML = `
            <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden max-h-[90vh] flex flex-col">
                <div class="p-6 md:p-8 flex-shrink-0">
                    <div class="flex items-start justify-between mb-4">
                        <span class="tag ${style.tag}">${issue.category}</span>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-white" aria-label="모달 닫기">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <h3 id="modal-title" class="text-2xl font-bold text-white flex items-start mb-2">${style.icon} <span class="flex-1">${issue.cause}</span></h3>
                    <div class="flex items-center text-sm text-gray-400">
                        <span>발생: ${issue.date}</span><span class="mx-2">|</span><span>소요: ${issue.duration}</span>
                    </div>
                </div>
                <div class="px-6 md:px-8 pb-8 overflow-y-auto">
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-400 mb-2">문제 상황</h4>
                            <p class="text-gray-300 leading-relaxed">${issue.background}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-sky-400 mb-2">해결 조치</h4>
                            <p class="text-sky-300 leading-relaxed">${issue.solution}</p>
                        </div>
                        ${preSolutionModalHTML}
                    </div>
                </div>
            </div>`;
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContentWrapper.classList.remove('scale-95');
            document.getElementById('modal-close-btn').focus();
        }, 10);

        document.addEventListener('keydown', trapFocus);
        document.getElementById('modal-close-btn').addEventListener('click', closeModal);
    };
    
    const closeModal = () => {
        modal.classList.add('opacity-0');
        modalContentWrapper.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
            modalContentWrapper.innerHTML = '';
            if(lastFocusedElement) lastFocusedElement.focus();
        }, 300);
        document.removeEventListener('keydown', trapFocus);
    };

    const trapFocus = (e) => {
        if (e.key !== 'Tab' && e.key !== 'Escape') return;

        if (e.key === 'Escape') {
            closeModal();
            return;
        }

        const focusableElements = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) { // Shift + Tab
            if (document.activeElement === firstElement) {
                lastElement.focus();
                e.preventDefault();
            }
        } else { // Tab
            if (document.activeElement === lastElement) {
                firstElement.focus();
                e.preventDefault();
            }
        }
    };

    issuesGrid.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (card) {
            const issueNo = parseInt(card.dataset.issueNo);
            const issue = allIssuesData.find(i => i.no === issueNo);
            if (issue) openModal(issue);
        }
    });

    calendarWrapper.addEventListener('click', e => {
        const dayElement = e.target.closest('button.calendar-day');
        if(dayElement) {
            const date = dayElement.dataset.date;
            // Toggle selection: if clicking the same date, deselect and show all
            if(currentFilter.type === FILTER_TYPE.DATE && currentFilter.value === date) {
                currentFilter = { type: FILTER_TYPE.CATEGORY, value: ALL_FILTER };
            } else {
                currentFilter = { type: FILTER_TYPE.DATE, value: date };
            }
            updateUI();
        }
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });

    // --- 초기화 ---
    const initialize = async () => {
        try {
            // 1. Fetch data
            const response = await fetch(ISSUES_JSON_PATH);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const issuesData = await response.json();
            allIssuesData = issuesData; // Store for later use

            // 2. Process data
            issuesData.forEach(issue => {
                const dateParts = issue.date.match(/(\d{2})-(\d{2})/);
                if (dateParts) {
                    const month = dateParts[1];
                    const day = dateParts[2];
                    issue.isoDate = `2025-${month}-${day}`;
                }
            });

            const issuesByDate = issuesData.reduce((acc, issue) => {
                if (issue.isoDate) {
                    if (!acc[issue.isoDate]) acc[issue.isoDate] = [];
                    acc[issue.isoDate].push(issue);
                }
                return acc;
            }, {});

            // 3. Render initial UI
            renderCalendar(2025, 3, issuesByDate); // April
            renderCalendar(2025, 4, issuesByDate); // May
            updateFilterCounts(issuesData);
            renderAllIssueCards(issuesData);
            updateCardVisibility(); // Show all cards initially

        } catch (error) {
            console.error('대시보드 초기화 실패:', error);
            issuesGrid.innerHTML = `<p class="col-span-full text-center text-red-400">이슈 데이터를 불러오는 데 실패했습니다. (${error.message})</p>`;
        }
    };

    initialize();

})();
</script>

</body>
</html>
